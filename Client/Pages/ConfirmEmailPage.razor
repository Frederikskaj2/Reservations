@page "/bekraeft-mail"
@inject ApiClient ApiClient
@inject NavigationManager NavigationManager

<main>
    @if (!isInitialized)
    {
        <Spinner />
    }
    else
    {
        <Container>
            @if (showErrorAlert)
            {
                <Alert Color="Color.Danger" Visible="true">
                    Der er sket en fejl, og din mail blev ikke bekræftet.
                </Alert>
            }
            else
            {
                <Paragraph>Din mail er nu bekræftet.</Paragraph>
                <Paragraph>Gå til <a href="@Urls.Calendar">kalenderen</a> for at reservere et lokale.</Paragraph>
            }
        </Container>
    }
</main>

@code {

    private bool isInitialized;
    private bool showErrorAlert;

    protected override async Task OnInitializedAsync()
    {
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryParser.GetQuery(NavigationManager.Uri);
        if (query.Contains("email") && query.Contains("token"))
        {
            var request = new ConfirmEmailRequest
            {
                Email = query["email"].FirstOrDefault(),
                Token = query["token"].FirstOrDefault()
            };
            var maybe = await ApiClient.PostJsonAsync<OperationResponse>("user/confirm-email", request);
            if (!maybe.TryGetValue(out var response) || response.Result == OperationResult.GeneralError)
                showErrorAlert = true;
        }
        else
        {
            showErrorAlert = true;
        }
        isInitialized = true;
    }
}